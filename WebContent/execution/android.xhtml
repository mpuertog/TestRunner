<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	template="../WEB-INF/templates/Layout.xhtml">

	<ui:define name="content">
		<h1 class="aw-page-title">Ejecución de Pruebas para Android</h1>

		<h:form id="androidForm" enctype="multipart/form-data">
			<p:fieldset legend="End to End" toggleable="true" toggleSpeed="500">
				<h:panelGrid columns="2" cellpadding="5">
					<h:graphicImage value="/resources/algaworks/images/androidLogo.png"
						width="100" />
					<h:outputText
						value="Ejecución de pruebas E2E utilizando el framework Calabash-Android"></h:outputText>
					<h:outputText value="Seleccione el APK a analizar: "
						style="width:85%" />
					<p:fileUpload value="#{androidMB.file}" mode="simple"
						skinSimple="true" allowTypes="*.apk" label="Seleccionar APK"
						cancelLabel="Cancelar" />
					<p:outputLabel for="emulator" value="Emulador: " />
					<p:selectOneMenu id="emulator"
						value="#{androidMB.selectedEmulatorID}" style="width:125px"
						onchange="submit()"
						valueChangeListener="#{androidMB.handleEmulatorChange}">
						<f:selectItems value="#{androidMB.androidEmulatorList}" var="emu"
							itemValue="#{emu.id}" />
					</p:selectOneMenu>
					<p:outputLabel for="gherkin" value="Código prueba: " />
					<p:inputTextarea id="gherkin" rows="6" cols="50"
						value="#{androidMB.gherkinCode}">
						<p:watermark for="gherkin"
							value="Código Gherkin de la prueba a ejecutar" id="watermark" />
					</p:inputTextarea>
					<p:commandButton value="Ejecutar Test E2E" ajax="false"
						actionListener="#{androidMB.runAndroidE2ETest()}"
						process=":androidForm" />
				</h:panelGrid>
			</p:fieldset>
			<p:fieldset legend="Visual Regresion" toggleable="true"
				toggleSpeed="500">
				<h:panelGrid columns="2" cellpadding="5">
					<h:graphicImage value="/resources/algaworks/images/resemblejs.png"
						width="100" />
					<h:outputText
						value="Ejecución de pruebas de regesión visual usando Resemble JS"></h:outputText>
					<h:outputText value="Imagen base: "
						style="width:85%" />
					<h:graphicImage value="/resources/algaworks/images/base_calendula.jpg"
					width="100" />
					<h:outputText value="Seleccione la imagen a analizar: "
						style="width:85%" />
					<input type="file" name="pic1" id="imagen_input" accept="image/*" />
					<p:commandButton value="Comparar" ajax="false"
						type="button"
						update=":androidForm" 
						onclick="comparar()"/>
					<div id="image-diff" class="small-drop-zone">
						Diferencias aparecen aqui
					</div>
				</h:panelGrid>
			</p:fieldset>
			
			<h:outputScript name="/algaworks/javascripts/resemble.js" />
			<h:outputScript name="/algaworks/javascripts/jquery.js" />
			<script>
			function comparar(){
				resemble(
						'/TestRunner/resources/algaworks/images/base_calendula.jpg').
					compareTo(document.getElementById("imagen_input").files[0]).onComplete(function(data){
					//console.log(data.getImageDataUrl());
					onComplete(data);
					/*
					{
					  misMatchPercentage : 100, // %
					  isSameDimensions: true, // or false
					  getImageDataUrl: function(){}
					}
					*/
				});
			}

			function onComplete(data){
				var time = Date.now();
				var diffImage = new Image();
				diffImage.src = data.getImageDataUrl();

				$('#image-diff').html(diffImage);

				$(diffImage).click(function(){
					var w = window.open("about:blank", "_blank");
					var html = w.document.documentElement;
					var body = w.document.body;

					html.style.margin = 0;
					html.style.padding = 0;
					body.style.margin = 0;
					body.style.padding = 0;

					var img = w.document.createElement("img");
					img.src = diffImage.src;
					img.alt = "image diff";
					img.style.maxWidth = "100%";
					img.addEventListener("click", function() {
						this.style.maxWidth = this.style.maxWidth === "100%" ? "" : "100%";
					});
					body.appendChild(img);
				});
			}
			</script>
		</h:form>
	</ui:define>
</ui:composition>